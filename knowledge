#!/bin/bash

# Global filter variable
FILTER="$1"

# --- ANSI COLOR CODES ---
C_RESET="\e[0m"
C_BOLD="\e[1m"
C_UNDERLINE="\e[4m"
C_DIM="\e[2m"

# Palette
C_APP="\e[1;36m" # Bold Cyan
C_LABEL="\e[90m" # Dark Gray (Dim)
C_CMD="\e[1;32m" # Bold Green
C_ARG="\e[1;33m" # Bold Yellow
C_TEXT="\e[37m"  # White

_formalize() {
 local app=""
 local synopsis=""
 local cmd_str=""
 local explanations=()

 # Process arguments
 while [[ "$#" -gt 0 ]]; do
  case $1 in
  --app)
   app="$2"
   shift
   ;;
  --synopsis)
   synopsis="$2"
   shift
   ;;
  --command)
   cmd_str="$2"
   shift
   ;;
  --explain)
   explanations+=("$2")
   shift
   ;;
  *) ;;
  esac
  shift
 done

 # FILTER LOGIC
 if [[ -n "$FILTER" ]]; then
  if [[ "${app,,}" != *"${FILTER,,}"* ]]; then
   return
  fi
 fi

 # --- DISPLAY HEADER ---
 echo -e "${C_DIM}──────────────────────────────────────────────────────────────${C_RESET}"
 echo -e "${C_APP}${C_BOLD}${C_UNDERLINE}${app}${C_RESET}"
 echo -e " ${C_LABEL}Synopsis ::${C_RESET} ${synopsis}"
 echo -e " ${C_LABEL}Command  ::${C_RESET} ${C_CMD}${cmd_str}${C_RESET}"

 # --- PROCESS & DISPLAY BREAKDOWN (Pure Bash Alignment) ---
 if [ ${#explanations[@]} -gt 0 ]; then
  echo -e " ${C_LABEL}Breakdown::${C_RESET}"

  # 1. Calculate the maximum length of the "Argument" (Left side)
  local max_len=0
  for explanation in "${explanations[@]}"; do
   local lhs="${explanation%%:*}"
   if [[ ${#lhs} -gt $max_len ]]; then
    max_len=${#lhs}
   fi
  done

  # 2. Print with dynamic padding
  for explanation in "${explanations[@]}"; do
   local lhs="${explanation%%:*}"
   local rhs="${explanation#*:}"

   # If line has no colon, print plainly
   if [[ "$lhs" == "$explanation" ]]; then
    echo -e "   ${C_TEXT}ⓘ $lhs${C_RESET}"
   else
    # printf format: Indent + ColorArg + PaddedString + Reset + Separator + Description
    printf "   ${C_ARG}%-${max_len}s${C_RESET}  ${C_DIM}:${C_RESET}  ${C_TEXT}%s${C_RESET}\n" "$lhs" "$rhs"
   fi
  done
 fi
 echo
}

function knowledge {

 # GIT
 _formalize --app "Git" \
  --synopsis "Remove all untracked files from directory" \
  --command "git clean -nfd" \
  --explain "-n : dry-run (shows what will be done)" \
  --explain "-f : force (required to run actual clean)" \
  --explain "-d : delete untracked directories too"

 # KUBERNETES
 _formalize --app "Kubernetes" \
  --synopsis "Launch temporary busybox pod for debugging" \
  --command "kubectl run -it --rm debug --image=busybox --restart=Never -- sh" \
  --explain "-it : Interactive TTY mode" \
  --explain "--rm : Delete pod automatically on exit" \
  --explain "--restart=Never : Run as Pod, not Deployment"

 # TMUX
 _formalize --app "Tmux" \
  --synopsis "Synchronize panes (typing mimics across all panes)" \
  --command "Ctrl+b :setw synchronize-panes" \
  --explain "Ctrl+b : Prefix key" \
  --explain ":setw ... : Enters command prompt inside Tmux" \
  --explain "Use Case : Updating multiple servers at once"

 # AWK
 _formalize --app "Awk" \
  --synopsis "Print specific columns from output" \
  --command "docker ps | awk '{print \$1, \$NF}'" \
  --explain "\$1 : First column (ID)" \
  --explain "\$NF : Last column (Name)" \
  --explain "Note : Default delimiter is whitespace"

 # BASH - Substitution
 _formalize --app "Bash (History)" \
  --synopsis "Fix typo in previous command" \
  --command "^old^new" \
  --explain "^old : String to find in previous command" \
  --explain "^new : String to replace it with"

 # GREP
 _formalize --app "Grep" \
  --synopsis "Recursive search with line numbers" \
  --command "grep -rn \"search_term\" ." \
  --explain "-r : Recursive search" \
  --explain "-n : Show line numbers" \
  --explain ". : Search current directory"

 # COLUMN
 _formalize --app "Column" \
  --synopsis "Format messy CLI output into tables" \
  --command "mount | column -t" \
  --explain "-t : Auto-detect columns" \
  --explain "Pipe : Use '|' to feed data into this"

 # BASH - Brace
 _formalize --app "Bash (Brace)" \
  --synopsis "Quick file backup / generation" \
  --command "cp file.txt{,.bak}" \
  --explain "{a,b} : Expands to 'file.txt' and 'file.txt.bak'" \
  --explain "Use Case : Quick config backups"

 _formalize --app "Toilet" \
  --synopsis "Pretty print text / ascii generation" \
  --command "toilet -f slant --filter metal 'Hello World'" \
  --explain "--font   : selected font name" \
  --explain "--filter : metal,border..."

 _formalize --app "Bash (inline hidden files)" \
  --synopsis "Format all hidden files at current directory" \
  --command 'for f in .*; do [ -f "$f" ] && shfmt -i 1 -w "$f"; done' \
  --explain "shfmt  : shell format" \
  --explain "-i     : indent by 1 space" \
  --explain "-w     : write to file"

  _formalize --app "Vim (NERDTree)" \
  --synopsis "Toggle the file browser sidebar" \
  --command ":NERDTreeToggle (Ctrl + n)" \
  --explain ":NERDTreeToggle : Command to open/close the tree" \
  --explain "<C-n> : Common custom keybinding (Ctrl+n)" \
  --explain "? : Press inside tree for help menu"

}

# execute the function while retaining color
knowledge | less -R
