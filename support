#!/bin/bash

# --- Global Variables ---
BACKUP_PATH="$HOME/env-backup.tar"
TMUX_CONFIG_DIR="$HOME/.config/tmux"
LOG_FILE="$HOME/dev-init.log"

# --- Helper Functions ---
function log() {
 echo -e "$@"
 echo "[$(date)] $@" >>"$LOG_FILE"
}

function install-font {

 log "--- üÖ∞Ô∏è  Font Installation ---"

 local path
 read -e -r -p "Enter the compressed font tar file path: " path

 while true; do
  if [[ -f "$path" ]]; then
   break
  fi
  log "‚ùå Invalid path. File not found."
  read -e -r -p "Enter nerdfont tar path: " path
 done

 local font_name
 font_name=$(basename "$path")

 # Corrected to >/dev/null 2>&1
 mkdir -p "$HOME/.fonts" >/dev/null 2>&1

 log "Extracting $font_name..."
 tar -xf "$path" -C "$HOME/.fonts"

 if [[ "$?" -ne 0 ]]; then
  log "‚ùå Failed to extract font."
 fi

 log "Rebuilding font cache (this may take a moment)..."
 fc-cache -f # Use -f to force formatting

 if [[ "$?" -eq 0 ]]; then
  log "‚úÖ Successfully installed font: $font_name"
 else
  log "‚ùå Failed to rebuild font cache."
  return 1
 fi
}

function tmux-fix {

 local offline_install="true"
 log "--- üõ†Ô∏è  Initializing Tmux ---"

 local CONF_FILE="$TMUX_CONFIG_DIR/tmux.conf"
 local TPM_DIR="$TMUX_CONFIG_DIR/plugins/tpm"

 # We kill the server because changes to the base configuration
 # often require a fresh server process, not just a configuration reload.
 log "Terminating existing Tmux server..."
 tmux kill-server 2>/dev/null
 log "‚úÖ Tmux server killed."

 mkdir -p "$TMUX_CONFIG_DIR"

 if [[ ! -d "$TPM_DIR" ]] || [[ -z "$(ls -A "$TPM_DIR" 2>/dev/null)" ]]; then

  if [[ "$offline_install" == "true" ]]; then
   local SRC_PATH
   read -e -r -p "Enter local path to Tmux Plugin Manager (TPM): " SRC_PATH

   if [[ -d "$SRC_PATH" ]]; then
    log "‚¨áÔ∏è  Copying TPM from local source..."
    cp -rf "$SRC_PATH" "$TPM_DIR"
   else
    log "‚ùå Source path does not exist. Skipping TPM install."
    return 1
   fi

   # Typo Fix: TMP_DIR -> TPM_DIR
   local file_count
   file_count=$(find "$TPM_DIR" -maxdepth 1 -type f 2>/dev/null | wc -l)

   # Note: TPM directory might only contain folders (git), so we check generally
   if [[ ! -d "$TPM_DIR" ]]; then
    log "‚ùå Failure copying files to: $TPM_DIR"
    return 1
   fi
  else
   log "‚¨áÔ∏è  Installing TPM from remote (GitHub)..."
   git clone https://github.com/tmux-plugins/tpm "$TPM_DIR"
  fi
 else
  log "‚úÖ TPM is already installed."
 fi

 # Initialize Plugins
 # Note: If strictly offline, this step may fail if plugins aren't pre-cached.
 if [[ -x "$TPM_DIR/bin/install_plugins" ]]; then
  log "‚¨áÔ∏è  Installing/Loading plugins..."
  "$TPM_DIR/bin/install_plugins" >/dev/null 2>&1
 fi

 # 'exec' replaces the current shell process, killing the 'initialize' function
 # and preventing any subsequent steps (like the final success message).
 # We will start tmux only at the very end of the main script.
 log "‚úÖ Tmux setup complete. Ready to launch."
}

function initialize {

 local SCRIPT_DIR
 SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

 log "--- üöÄ Initializing Dev Environment ---"

 local answer
 # Syntax Fix: 'read -p prompt var'. Removed the colon inside the variable position.
 read -p "Continue with initialization? (y/n): " answer

 if [[ "$answer" != "y" ]]; then
  log "Terminating..."
  exit 0
 fi

 # --- Bashrc Handling ---
 if [[ -L "$HOME/.bashrc" ]]; then
  log "‚ÑπÔ∏è  .bashrc is already a symlink. Skipping."
 else
  log "üì¶ Backing up existing ~/.bashrc to $BACKUP_PATH"
  tar -cf "$BACKUP_PATH" "$HOME/.bashrc" 2>/dev/null

  log "Replacing existing bashrc..."
  rm "$HOME/.bashrc"

  # We want to error if the file STILL exists (-e).
  if [[ -e "$HOME/.bashrc" ]]; then
   log "‚ùå Failure removing existing bashrc. Aborting."
   exit 1
  fi

  ln -s "$SCRIPT_DIR/.bashrc" "$HOME/.bashrc"

  if [[ -L "$HOME/.bashrc" ]]; then
   log "‚úÖ Update of bashrc complete!"
  else
   log "‚ùå Failure updating bashrc. Rolling back..."
   tar -xf "$BACKUP_PATH" -C "$HOME/"
   exit 1
  fi
 fi

 # --- Tmux Config Handling ---
 local possible_paths=("$HOME/.config/tmux" "$HOME/.tmux" "$HOME/.tmux.conf")

 for possible in "${possible_paths[@]}"; do
  if [[ -e "$possible" ]]; then
   log "üì¶ Found existing config: $possible. Backing up..."

   # Append to backup (-r or -u)
   tar -rf "$BACKUP_PATH" "$possible" >/dev/null 2>&1

   if tar -tf "$BACKUP_PATH" "$possible" >/dev/null 2>&1; then
    log "‚úÖ File backed-up: $possible"

    # Removed the interactive prompt inside the loop for cleaner automation.
    # If you want it back, uncomment the read/if block.

    rm -rf "$possible" >/dev/null 2>&1

    if [[ -e "$possible" ]]; then
     log "‚ùå Failed to remove old directory: $possible"
     exit 1
    fi
   else
    log "‚ùå Failure verifying backup for $possible. Aborting."
    exit 1
   fi
  fi
 done

 # Create config directory
 mkdir -p "$TMUX_CONFIG_DIR" >/dev/null 2>&1

 log "üìÇ Copying new tmux configuration..."
 if [[ -d "$SCRIPT_DIR/.config/tmux" ]]; then
  cp -rf "$SCRIPT_DIR/.config/tmux/." "$TMUX_CONFIG_DIR/"
 else
  log "‚ö†Ô∏è  Warning: Source config directory '$SCRIPT_DIR/.config/tmux' not found."
 fi

 # Final assertion
 if [[ ! -d "$TMUX_CONFIG_DIR" ]]; then
  log "‚ùå Critical Error: $TMUX_CONFIG_DIR does not exist."
  exit 1
 else
  log "‚úÖ Tmux files copied successfully."
 fi

 # Run the Tmux fix logic
 if ! tmux-fix; then
  log "‚ùå Failed initializing tmux settings."
  exit 1
 fi

 log "‚ú® Environment Initialized Successfully! Starting Tmux..."

 # Now we can exec into tmux
 exec tmux -f "$TMUX_CONFIG_DIR/tmux.conf"
}

# --- Main Execution ---
# Call the main function
initialize
