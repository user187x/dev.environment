#!/bin/bash

# $1 is the Pane PID passed from tmux
CURRENT_PID=$1

# Validation
if [ -z "$CURRENT_PID" ]; then exit 0; fi

# --- FUNCTION: Recursive Child Finder ---
find_deepest_child() {
 local parent=$1
 # -n: select the newest (most recently started) child
 local child=$(pgrep -P "$parent" -n)

 if [ -z "$child" ]; then
  echo "$parent"
 else
  find_deepest_child "$child"
 fi
}
# ----------------------------------------

# 1. Attempt to find the deepest active process
LEAF_PID=$(find_deepest_child "$CURRENT_PID")

# 2. Try to generate the tree for this child.
#    2>/dev/null hides errors if the PID is already dead.
TREE_OUTPUT=$(pstree -p -A -s "$LEAF_PID" 2>/dev/null | head -n 1)

# 3. FALLBACK: If the child died (output is empty), use the original Pane PID.
#    This prevents the "disappearing" text issue.
if [ -z "$TREE_OUTPUT" ]; then
 LEAF_PID=$CURRENT_PID
 TREE_OUTPUT=$(pstree -p -A -s "$LEAF_PID" | head -n 1)
fi

# 4. Format the output
#    We echo the captured variable into sed.
echo "$TREE_OUTPUT" |
 sed "s/($LEAF_PID).*/($LEAF_PID)/; s/([0-9]*)//g; s/---/ ➤ /g; s/ ➤ -/ ➤ /g; s/^systemd ➤ systemd ➤ //; s/tmux: server/tmux/"
