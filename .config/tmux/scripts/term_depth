#!/bin/bash

# $1 = Pane PID (from tmux)
# $2 = Current Path
CURRENT_PID=$1
CURRENT_PATH=$2

# --- CONFIG: Colors (Dracula Theme) ---
# #50fa7b = Green, #ff79c6 = Pink, #8be9fd = Cyan, #f8f8f2 = White
VAL_COLOR="#[fg=#f8f8f2]"
RESET_COLOR="#[fg=default]"

# Validation
if [ -z "$CURRENT_PID" ]; then exit 0; fi

# Recursive Child Finder ---
find_deepest_child() {
 local parent=$1
 local child=$(pgrep -P "$parent" -n)

 if [ -z "$child" ]; then
  echo "$parent"
 else
  find_deepest_child "$child"
 fi
}

# ----------------------------------------

# 1. Find the Deepest Active Process (The Leaf)
LEAF_PID=$(find_deepest_child "$CURRENT_PID")

# 2. Get the USER who owns this specific process
#    -o user= : prints just the username
#    awk : trims any whitespace
LEAF_USER=$(ps -o user= -p "$LEAF_PID" | awk '{print $1}')

# 3. Generate the Tree (with fallback for race conditions)
TREE_OUTPUT=$(pstree -p -A -s "$LEAF_PID" 2>/dev/null | head -n 1)

if [ -z "$TREE_OUTPUT" ]; then
 LEAF_PID=$CURRENT_PID
 # Fallback: if child died, use parent PID and parent User
 LEAF_USER=$(ps -o user= -p "$LEAF_PID" | awk '{print $1}')
 TREE_OUTPUT=$(pstree -p -A -s "$LEAF_PID" | head -n 1)
fi

# 4. Clean up the tree visual
CLEAN_TREE=$(echo "$TREE_OUTPUT" |
 sed "s/($LEAF_PID).*/($LEAF_PID)/; s/([0-9]*)//g; s/---/ ➤ /g; s/ ➤ -/ ➤ /g; s/^systemd ➤ systemd ➤ //; s/tmux: server/tmux/")

echo "User [${VAL_COLOR}${LEAF_USER}${RESET_COLOR}] Path [${VAL_COLOR}${CURRENT_PATH}${RESET_COLOR}] Terminal-Depth [${VAL_COLOR}${CLEAN_TREE}${RESET_COLOR}]"
