#!/bin/bash

# $1 = Pane PID (from tmux)
# $2 = Current Path
CURRENT_PID=$1
CURRENT_PATH=$2

# --- CONFIG: Colors (Dracula Theme) ---
# #50fa7b = Green, #ff79c6 = Pink, #8be9fd = Cyan, #f8f8f2 = White
VAL_COLOR="#[fg=#f8f8f2]"
RESET_COLOR="#[fg=default]"
FILE_COLOR="#[fg=#ff79c6]"

# Validation
if [ -z "$CURRENT_PID" ]; then exit 0; fi

# Recursive Child Finder ---
find_deepest_child() {
  local parent=$1
  local child=$(pgrep -P "$parent" -n)

  if [ -z "$child" ]; then
    echo "$parent"
  else
    find_deepest_child "$child"
  fi
}

# ----------------------------------------

# 1. Find the Deepest Active Process (The Leaf)
LEAF_PID=$(find_deepest_child "$CURRENT_PID")

# 2. Get the USER who owns this specific process
LEAF_USER=$(ps -o user= -p "$LEAF_PID" | awk '{print $1}')

# 3. Generate the Tree (with fallback for race conditions)
TREE_OUTPUT=$(pstree -p -A -s "$LEAF_PID" 2>/dev/null | head -n 1)

if [ -z "$TREE_OUTPUT" ]; then
  LEAF_PID=$CURRENT_PID
  LEAF_USER=$(ps -o user= -p "$LEAF_PID" | awk '{print $1}')
  TREE_OUTPUT=$(pstree -p -A -s "$LEAF_PID" | head -n 1)
fi

# 4. Clean up the tree visual
CLEAN_TREE=$(echo "$TREE_OUTPUT" |
  sed "s/($LEAF_PID).*/($LEAF_PID)/; s/([0-9]*)//g; s/---/ ➤ /g; s/ ➤ -/ ➤ /g; s/^systemd ➤ systemd ➤ //; s/tmux: server/tmux/")

# 4b. Color the LEAF node (The last item in the tree)
if [[ "$CLEAN_TREE" == *" ➤ "* ]]; then
  CLEAN_TREE=$(echo "$CLEAN_TREE" | sed "s/\(.*\)\( ➤ \)\(.*\)/\1\2${FILE_COLOR}\3/")
else
  CLEAN_TREE="${FILE_COLOR}${CLEAN_TREE}"
fi

# ----------------------------------------
# 5. Extract Current Open File
# ----------------------------------------

CMD_NAME=$(ps -o comm= -p "$LEAF_PID" 2>/dev/null)
CMD_ARGS=$(ps -o args= -p "$LEAF_PID" 2>/dev/null)
FILE_DISPLAY=""

if [[ "$CMD_NAME" =~ (vi|vim|nvim|nano|emacs|micro|less|more|bat|cat|man) ]]; then
  RAW_FILE=$(echo "$CMD_ARGS" | awk '{print $NF}')
  if [[ "$RAW_FILE" != "$CMD_NAME" ]]; then
    BASE_FILE=$(basename "$RAW_FILE")
    FILE_DISPLAY=" File [${FILE_COLOR}${BASE_FILE}${RESET_COLOR}]"
  fi
elif [[ "$CMD_NAME" == "ssh" ]]; then
  SSH_HOST=$(echo "$CMD_ARGS" | awk '{print $NF}')
  FILE_DISPLAY=" SSH [${FILE_COLOR}${SSH_HOST}${RESET_COLOR}]"
fi

# ----------------------------------------
# 6. NEW: Color the Last Directory in Path
# ----------------------------------------

# Logic: Regex matches the characters after the very last slash (or the whole string if no slash)
# and wraps them in FILE_COLOR.
if [ "$CURRENT_PATH" == "/" ]; then
    COLORED_PATH="${FILE_COLOR}/${RESET_COLOR}"
else
    COLORED_PATH=$(echo "$CURRENT_PATH" | sed "s|\([^/]*\)$|${FILE_COLOR}\1${RESET_COLOR}|")
fi

# ----------------------------------------

echo "User [${VAL_COLOR}${LEAF_USER}${RESET_COLOR}] Path [${VAL_COLOR}${COLORED_PATH}${RESET_COLOR}]${FILE_DISPLAY} Terminal [${VAL_COLOR}${CLEAN_TREE}${RESET_COLOR}]"
