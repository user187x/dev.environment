#!/bin/bash

# 1. Update repositories first
echo "Updating package lists..."
sudo apt update -y

# format: "binary_name:package_name"
# If package name matches binary, just put the name.
tools=(
 "tmux"
 "vim"
 "batcat:bat" # Binary is batcat, package is bat
 "curl"
 "wget"
 "openssl"
 "btop"
 "pluma"
 "gedit"
 "colordiff"
 "tty-clock"
 "java:default-jdk" # changed openjdk-25 to default-jdk (25 is rarely in default repos)
 "visualvm"
 "lolcat"
 "build-essential"
 "netstat:net-tools" # command is netstat, package is net-tools
 "jq"
 "notify-send:libnotify-bin"
 "yq"
 "figlet"
 "tree"
 "whiptail"
 "duf"
 "fzf"
 "delta:git-delta" # package is git-delta
 "thefuck"
 "shfmt"
 "shellcheck"
 "yamllint"
 "neofetch"
 "expect"
 "xmllint:libxml2-utils"
 "jc"
 "gufw"
 "ranger"
 "mc"
 "cmatrix"
)

failed=()
installed=()

echo "--- ðŸ“¦ Starting APT Tool Installation ---"

for item in "${tools[@]}"; do
 # Split the string by colon to get binary and package
 if [[ "$item" == *":"* ]]; then
  binary="${item%%:*}"
  package="${item##*:}"
 else
  binary="$item"
  package="$item"
 fi

 if ! command -v "$binary" >/dev/null 2>&1; then
  echo "Installing $package..."
  if ! sudo apt install "$package" -y; then
   echo -e "Tool [\e[1;91m$package\e[0m] failed to install"
   failed+=("$package")
  else
   echo -e "Tool [\e[1;92m$package\e[0m] Installed"
   installed+=("$package")
  fi
 else
  echo -e "Tool [\e[1;92m$package\e[0m] already installed"
  installed+=("$package")
 fi
done

echo ""
echo -e "(i) Total Tools     : \e[1;94m${#tools[@]}\e[0m"
echo -e "(i) Total Installed : \e[1;92m${#installed[@]}\e[0m"

count="${#failed[@]}"

if [[ "$count" -eq 0 ]]; then
 msg="\e[1;92m$count\e[0m"
else
 msg="\e[1;91m$count\e[0m"
fi

echo -e "(i) Total Failed    : $msg"

if [[ "${#tools[@]}" -ne "${#installed[@]}" ]]; then
 echo "Tools Missing/Failed:"
 for tool in "${failed[@]}"; do
  echo -e " [\e[1;91m$tool\e[0m]"
 done
else
 echo -e "(i) \e[1;92mAll apt tools processed successfully!\e[0m"
fi

echo ""
echo "--- ðŸš€ Starting Custom Installations ---"

# Install ghostty terminal
if ! command -v ghostty >/dev/null 2>&1; then
 echo "Installing ghostty..."
 # Ensure curl is installed before running this
 sudo apt install curl -y
 curl -fsSL https://raw.githubusercontent.com/mkasberg/ghostty-ubuntu/HEAD/install.sh | sh
fi

# Install Helm
if ! command -v helm >/dev/null 2>&1; then
 echo "Installing helm..."
 # Changed get-helm-4 to get-helm-3 (standard script)
 curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
 rm get_helm.sh
fi

# Install Docker
if ! command -v docker >/dev/null 2>&1; then
 echo "Installing Docker..."
 curl -fsSL https://get.docker.com | sh
 # Add current user to docker group so sudo isn't needed
 sudo usermod -aG docker "$USER"
 echo "Docker installed. You may need to logout/login for group changes to take effect."
fi

# Install system monitor
if ! command -v indicator-multiload >/dev/null 2>&1; then
 echo "Installing indicator-multiload..."
 sudo apt install indicator-multiload -y
fi

# Install tools for extensions
if ! command -v gnome-shell-extension-manager >/dev/null 2>&1; then
 echo "Installing gnome-shell-extension-manager..."
 sudo apt install gnome-shell-extension-manager -y
fi

# Install desktop editor
if ! command -v dconf-editor >/dev/null 2>&1; then
 echo "Installing dconf-editor..."
 sudo apt install dconf-editor -y
fi

# Install VS Code (Desktop Version)
if ! command -v code >/dev/null 2>&1; then
 echo "Installing VS Code (Snap)..."
 sudo snap install code --classic
fi

# Install Flatpak (Prerequisite for Mission Center)
if ! command -v flatpak >/dev/null 2>&1; then
 echo "Installing flatpak..."
 sudo apt install flatpak -y
 flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
fi

# Install Mission Center (Independent check)
if ! flatpak list 2>/dev/null | grep -q "io.missioncenter.MissionCenter"; then
 echo "Installing MissionCenter..."
 flatpak install flathub io.missioncenter.MissionCenter -y
else
 echo "MissionCenter already installed."
fi

# Install LazyDocker
if ! command -v lazydocker >/dev/null 2>&1; then
 echo "Installing lazydocker..."
 curl https://raw.githubusercontent.com/jesseduffield/lazydocker/master/scripts/install_update_linux.sh | bash
fi

# Install K9
if ! command -v k9s >/dev/null 2>&1; then
 K9S_VERSION="v0.32.5"
 echo "Installing k9s..."
 TMP_DIR=$(mktemp -d)
 curl -L "https://github.com/derailed/k9s/releases/download/${K9S_VERSION}/k9s_Linux_amd64.tar.gz" -o "$TMP_DIR/k9s.tar.gz"
 tar -xzf "$TMP_DIR/k9s.tar.gz" -C "$TMP_DIR"
 sudo install -m 755 "$TMP_DIR/k9s" /usr/local/bin/k9s
 rm -rf "$TMP_DIR"
fi

# Center Windows
echo "Configuring GNOME Window settings..."
# We wrap this in a try/catch style because gsettings might fail on headless servers
if command -v gsettings >/dev/null 2>&1; then
 centered=$(gsettings get org.gnome.mutter center-new-windows)
 # Fixed boolean logic check
 if [[ "$centered" != "'true'" && "$centered" != "true" ]]; then
  echo "Setting all windows to be centered!"
  gsettings set org.gnome.mutter center-new-windows true
 fi
fi

echo "--- âœ¨ Setup Complete! ---"
