#!/bin/bash
set -e

# --- Configuration ---
DOMAIN="mycompany.com"
RANCHER_HOSTNAME="rancher.$DOMAIN"
WILDCARD_DOMAIN="*.$DOMAIN"
NAMESPACE="cattle-system"
CERT_DIR="./certs"

# --- Colors ---
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

echo -e "${BLUE}ðŸš€ Starting Rancher Zero-to-Hero (Air-Gap Simulation)...${NC}"

# 0. Cleanup Previous Runs (Optional but recommended)
echo -e "${YELLOW}ðŸ§¹ Cleaning up old resources...${NC}"
helm uninstall rancher -n $NAMESPACE 2>/dev/null || true
kubectl delete ns $NAMESPACE 2>/dev/null || true
rm -rf $CERT_DIR
mkdir -p $CERT_DIR

# 1. Generate Private CA and Wildcard Certificates
echo -e "${BLUE}ðŸ” Generating Private PKI (CA & Wildcard Certs)...${NC}"

# 1a. Create the Root CA
openssl genrsa -out $CERT_DIR/ca.key 4096
openssl req -x509 -new -nodes -key $CERT_DIR/ca.key -sha256 -days 3650 \
 -subj "/C=US/ST=Private/L=AirGap/O=MyCompany/OU=IT/CN=MyCompanyRootCA" \
 -out $CERT_DIR/ca.crt

echo -e "${GREEN}âœ” Root CA generated.${NC}"

# 1b. Create the Wildcard Certificate Key and CSR
openssl genrsa -out $CERT_DIR/tls.key 2048
openssl req -new -key $CERT_DIR/tls.key \
 -subj "/C=US/ST=Private/L=AirGap/O=MyCompany/OU=IT/CN=$WILDCARD_DOMAIN" \
 -out $CERT_DIR/tls.csr

# 1c. Create a config file to ensure SANs (Subject Alternative Names) are present
# This is critical for Chrome/modern browsers to accept the cert.
cat >$CERT_DIR/openssl.cnf <<EOF
authorityKeyIdentifier=keyid,issuer
basicConstraints=CA:FALSE
keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment
subjectAltName = @alt_names

[alt_names]
DNS.1 = $WILDCARD_DOMAIN
DNS.2 = $RANCHER_HOSTNAME
EOF

# 1d. Sign the Wildcard Cert with our Root CA
openssl x509 -req -in $CERT_DIR/tls.csr \
 -CA $CERT_DIR/ca.crt -CAkey $CERT_DIR/ca.key \
 -CAcreateserial -out $CERT_DIR/tls.crt \
 -days 825 -sha256 -extfile $CERT_DIR/openssl.cnf

echo -e "${GREEN}âœ” Wildcard Certificate (*.$DOMAIN) generated and signed.${NC}"

# 2. Install Cert-Manager (REQUIRED by Rancher even if using custom certs)
echo -e "${BLUE}ðŸ“¦ Installing Cert-Manager (Prerequisite)...${NC}"
helm repo add jetstack https://charts.jetstack.io >/dev/null 2>&1
helm repo update >/dev/null 2>&1

helm upgrade --install cert-manager jetstack/cert-manager \
 --namespace cert-manager \
 --create-namespace \
 --set crds.enabled=true \
 --wait

echo -e "${GREEN}âœ” Cert-Manager installed.${NC}"

# 3. Prepare Rancher Namespace and Secrets
echo -e "${BLUE}ðŸ›¡ï¸  Creating Rancher Namespace and Injecting Secrets...${NC}"
kubectl create ns $NAMESPACE 2>/dev/null || true

# Secret 1: The Wildcard Certificate (tls.crt + tls.key)
# Rancher uses this to serve HTTPS traffic.
kubectl -n $NAMESPACE create secret tls tls-rancher-ingress \
 --cert=$CERT_DIR/tls.crt \
 --key=$CERT_DIR/tls.key \
 --dry-run=client -o yaml | kubectl apply -f -

# Secret 2: The CA Certificate (ca.crt)
# Rancher uses this to trust itself and downstream clusters.
# IMPORTANT: File must be named 'cacerts.pem' inside the secret for Rancher to see it.
kubectl -n $NAMESPACE create secret generic tls-ca \
 --from-file=cacerts.pem=$CERT_DIR/ca.crt \
 --dry-run=client -o yaml | kubectl apply -f -

echo -e "${GREEN}âœ” Secrets 'tls-rancher-ingress' and 'tls-ca' created.${NC}"

# 4. Install Rancher
echo -e "${BLUE}ðŸ¤  Installing Rancher (Stable)...${NC}"
helm repo add rancher-stable https://releases.rancher.com/server-charts/stable >/dev/null 2>&1
helm repo update >/dev/null 2>&1

helm install rancher rancher-stable/rancher \
 --namespace $NAMESPACE \
 --set hostname=$RANCHER_HOSTNAME \
 --set bootstrapPassword=admin \
 --set ingress.tls.source=secret \
 --set privateCA=true \
 --wait \
 --timeout 10m

echo -e "${GREEN}âœ… Rancher Pod is Running.${NC}"

# 5. Final Instructions
echo -e "\n${YELLOW}---------------------------------------------------${NC}"
echo -e "${GREEN}ðŸŽ‰ INSTALLATION COMPLETE!${NC}"
echo -e "${YELLOW}---------------------------------------------------${NC}"

# Try to find the IP (Best effort)
NODE_IP=""
if command -v minikube &>/dev/null; then
 NODE_IP=$(minikube ip)
else
 NODE_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}')
fi

echo -e "To access Rancher, you must configure your local DNS:"
echo -e "1. Edit your hosts file (sudo nano /etc/hosts on Linux/Mac, or Drivers/etc/hosts on Windows)."
echo -e "2. Add the following line:"
echo -e "   ${BLUE}$NODE_IP  $RANCHER_HOSTNAME${NC}"
echo -e ""
echo -e "3. **CRITICAL STEP for PKI Trust**:"
echo -e "   Import the generated CA file into your browser's Trusted Root Store."
echo -e "   File location: ${BLUE}$CERT_DIR/ca.crt${NC}"
echo -e ""
echo -e "4. Navigate to: https://$RANCHER_HOSTNAME"
echo -e "   (Login with user: 'admin', password: 'admin')"
