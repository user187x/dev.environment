#!/bin/bash

ACTUAL_USER="${SUDO_USER:-$USER}"
ACTUAL_UID=$(id -u "$ACTUAL_USER")

SERVICE_NAME="shutdown-hook.service"
SOUND_FILE="/opt/audio/MegamanDefeat.wav"

if [ ! -f "$SOUND_FILE" ]; then
 echo "Error: Sound file not found at $SOUND_FILE"
 exit 1
fi

echo "Creating service for user: $ACTUAL_USER (UID: $ACTUAL_UID)..."

cat <<EOF | sudo tee "/etc/systemd/system/$SERVICE_NAME" > /dev/null
[Unit]
Description=Play sound on shutdown
After=sound.target alsa-restore.service

[Service]
Type=oneshot
RemainAfterExit=true

# Use variables we detected earlier
User=$ACTUAL_USER
Environment=XDG_RUNTIME_DIR=/run/user/$ACTUAL_UID

ExecStart=/bin/true
ExecStop=/usr/bin/mpv --no-video "$SOUND_FILE"

[Install]
WantedBy=multi-user.target
EOF

# 3. Reload and Enable
echo "Reloading systemd..."
sudo systemctl daemon-reload

echo "Enabling service..."
sudo systemctl enable "$SERVICE_NAME"

echo "Starting service (hook acts active immediately)..."
sudo systemctl start "$SERVICE_NAME"

echo "Done! The sound will play on next shutdown."
