#!/bin/bash

# --- 1. Safety & Strict Mode ---
set -uo pipefail

# --- Global Variables ---
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
BACKUP_PATH="$HOME/env-backup-${TIMESTAMP}.tar"
TMUX_CONFIG_DIR="$HOME/.config/tmux"
LOG_FILE="$HOME/dev-init-${TIMESTAMP}.log"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Global Flag for Dry Run (Default to false)
DRY_RUN="false"

# --- Helper Functions ---

function log() {
 echo -e "$@" | tee -a "$LOG_FILE"
}

function error_exit() {
 log "‚ùå Critical Error: $1"
 exit 1
}

# --- üß± CORE DRY-RUN LOGIC ---
# This function wraps all destructive commands.
# If DRY_RUN is true, it just prints the command.
# If DRY_RUN is false, it executes it using eval (to handle pipes/redirects).
function safe_execute() {
 local cmd="$*"

 if [[ "$DRY_RUN" == "true" ]]; then
  log "üß± [DRY RUN] Would execute: $cmd"
  return 0 # Always return success in dry run so the script continues
 else
  # specific check for 'exec' which replaces the shell
  if [[ "$cmd" == exec* ]]; then
   eval "$cmd"
  else
   eval "$cmd"
  fi
 fi
}

function check_dependencies() {
 local deps=("tmux" "tar" "git" "fc-cache")
 for cmd in "${deps[@]}"; do
  if ! command -v "$cmd" &>/dev/null; then
   # In dry run, we might be testing on a machine missing deps, so we warn instead of fail
   if [[ "$DRY_RUN" == "true" ]]; then
    log "‚ö†Ô∏è  [DRY RUN] Missing dependency '$cmd' (ignoring for test)"
   else
    error_exit "Required command '$cmd' is not installed."
   fi
  fi
 done
}

function install_font() {
 log "--- üÖ∞Ô∏è  Font Installation ---"

 # In dry run, we skip the interactive prompts to automate the test flow
 if [[ "$DRY_RUN" == "true" ]]; then
  log "üß± [DRY RUN] Skipping interactive font prompts."
  log "üß± [DRY RUN] Would extract font to $HOME/.fonts and run fc-cache -f"
  return 0
 fi

 read -r -p "Do you want to install a nerd font? (y/n): " do_font
 if [[ "$do_font" != "y" ]]; then return 0; fi

 local path
 read -e -r -p "Enter the compressed font tar file path: " path

 while true; do
  path="${path/#\~/$HOME}"
  if [[ -f "$path" ]]; then break; fi
  log "‚ùå Invalid path. File not found: $path"
  read -e -r -p "Enter nerdfont tar path: " path
 done

 safe_execute "mkdir -p \"$HOME/.fonts\" >/dev/null 2>&1"
 safe_execute "tar -xf \"$path\" -C \"$HOME/.fonts\""

 log "Rebuilding font cache..."
 safe_execute "fc-cache -f"
}

function tmux_fix() {
 local offline_install="false"
 log "--- üõ†Ô∏è  Initializing Tmux ---"
 local TPM_DIR="$TMUX_CONFIG_DIR/plugins/tpm"

 if pgrep -x "tmux" >/dev/null; then
  if [[ "$DRY_RUN" == "true" ]]; then
   log "üß± [DRY RUN] Would prompt to kill existing Tmux server."
  else
   log "‚ö†Ô∏è  A Tmux server is currently running."
   read -r -p "Kill existing Tmux server to apply changes? (y/n): " kill_ans
   if [[ "$kill_ans" == "y" ]]; then
    safe_execute "tmux kill-server 2>/dev/null || true"
   fi
  fi
 fi

 safe_execute "mkdir -p \"$TMUX_CONFIG_DIR\""

 if [[ ! -d "$TPM_DIR" ]]; then
  # We assume online for dry run logic to show the git clone
  log "‚¨áÔ∏è  Installing TPM from remote (GitHub)..."
  safe_execute "git clone https://github.com/tmux-plugins/tpm \"$TPM_DIR\""
 else
  log "‚úÖ TPM is already installed."
 fi

 if [[ -x "$TPM_DIR/bin/install_plugins" ]]; then
  log "‚¨áÔ∏è  Installing/Loading plugins..."
  safe_execute "\"$TPM_DIR/bin/install_plugins\" >/dev/null 2>&1"
 fi
}

function initialize() {
 log "--- üöÄ Initializing Dev Environment ---"

 check_dependencies

 # Skip prompt in dry run
 if [[ "$DRY_RUN" == "false" ]]; then
  read -r -p "Continue with initialization? (y/n): " answer
  if [[ "$answer" != "y" ]]; then
   log "Terminating..."
   exit 0
  fi
 fi

 # --- Bashrc Handling ---
 if [[ -L "$HOME/.bashrc" ]]; then
  log "‚ÑπÔ∏è  .bashrc is already a symlink. Skipping."
 else
  log "üì¶ Backing up existing ~/.bashrc to $BACKUP_PATH"
  safe_execute "tar -cf \"$BACKUP_PATH\" \"$HOME/.bashrc\" 2>/dev/null || true"

  log "Replacing existing bashrc..."
  safe_execute "rm -f \"$HOME/.bashrc\""
  safe_execute "ln -s \"$SCRIPT_DIR/.bashrc\" \"$HOME/.bashrc\""
 fi

 # --- Tmux Config Handling ---
 local possible_paths=("$HOME/.config/tmux" "$HOME/.tmux" "$HOME/.tmux.conf")

 for possible in "${possible_paths[@]}"; do
  if [[ -e "$possible" ]]; then
   log "üì¶ Found existing config: $possible. Backing up..."
   safe_execute "tar -rf \"$BACKUP_PATH\" \"$possible\" 2>/dev/null"
   safe_execute "rm -rf \"$possible\""
  fi
 done

 safe_execute "mkdir -p \"$TMUX_CONFIG_DIR\""

 log "üìÇ Copying new tmux configuration..."
 if [[ -d "$SCRIPT_DIR/.config/tmux" ]]; then
  safe_execute "cp -rf \"$SCRIPT_DIR/.config/tmux/.\" \"$TMUX_CONFIG_DIR/\""
 else
  log "‚ö†Ô∏è  Warning: Source config directory '$SCRIPT_DIR/.config/tmux' not found."
 fi

 tmux_fix
 install_font

 # --- Sourcing files ---
 local aux_files=(".bash-tools" ".bash-aliases" ".bash-functions")
 for file in "${aux_files[@]}"; do
  if [[ -f "$SCRIPT_DIR/$file" ]]; then
   if [[ "$DRY_RUN" == "true" ]]; then
    log "üß± [DRY RUN] Would source: $SCRIPT_DIR/$file"
   else
    # shellcheck disable=SC1090
    source "$SCRIPT_DIR/$file"
   fi
  fi
 done

 log "‚ú® Environment Initialized Successfully!"

 if [[ "$DRY_RUN" == "true" ]]; then
  log "üß± [DRY RUN] Would exec: tmux -f $TMUX_CONFIG_DIR/tmux.conf"
 else
  if [[ -z "${TMUX:-}" ]]; then
   exec tmux -f "$TMUX_CONFIG_DIR/tmux.conf"
  else
   tmux source-file "$TMUX_CONFIG_DIR/tmux.conf"
  fi
 fi
}

# --- THE REQUESTED DRY-RUN FUNCTION ---
function start_dry_run() {
 echo "=========================================="
 echo "üß±  ENTERING DRY-RUN MODE"
 echo "=========================================="
 echo "No files will be modified. No commands will be executed."
 echo "Dependencies will be checked but not enforced."
 echo "Interactive prompts will be skipped."
 echo ""

 # 1. Set the global flag
 DRY_RUN="true"

 # 2. Invoke the standard main logic
 # Because DRY_RUN is true, 'safe_execute' will intercept commands
 initialize

 echo ""
 echo "=========================================="
 echo "‚úÖ  DRY-RUN COMPLETE"
 echo "=========================================="
}

# --- Main Entry Point Logic ---
# Check if the first argument is --dry-run
if [[ "${1:-}" == "--dry-run" ]]; then
 start_dry_run
else
 # Standard execution
 echo -e "\e[90m(i) Starting initialization script...\e[0m"
 initialize
fi
