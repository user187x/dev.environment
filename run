#!/bin/bash

#Safety & Strict Mode
set -uo pipefail

# Create temp directory
SCRATCH_SPACE="/tmp/dev-env"
if [[ ! -f "$SCRATCH_SPACE" ]]; then
 mkdir -p "/tmp/dev-env" > /dev/null 2>&1
fi

#Global Variables
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
BACKUP_PATH="$SCRATCH_SPACE/env-backup-${TIMESTAMP}.tar"
TMUX_CONFIG_DIR="$HOME/.config/tmux"
LOG_FILE="$SCRATCH_SPACE/dev-init-${TIMESTAMP}.log"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Global Flag for Dry Run (Default to false)
DRY_RUN="false"

# --- Helper Function ---
function log() {
 echo -e "$@" | tee -a "$LOG_FILE"
}

# --- Helper Function ---
function error_exit() {
 log "‚ùå Critical Error: $1"
 exit 1
}

# If DRY_RUN is false, it executes it using eval (to handle pipes/redirects).
function safe_execute() {
 local cmd="$*"

 if [[ "$DRY_RUN" == "true" ]]; then
  log "‚öôÔ∏è  [DRY RUN] Execute: $cmd"
  return 0 # Always return success in dry run so the script continues
 else
  # specific check for 'exec' which replaces the shell
  if [[ "$cmd" == exec* ]]; then
   eval "$cmd"
  else
   eval "$cmd"
  fi
 fi
}

function check_dependencies() {
 local deps=("tmux" "tar" "git" "fc-cache")
 for cmd in "${deps[@]}"; do
  if ! command -v "$cmd" &>/dev/null; then
   # In dry run, we might be testing on a machine missing deps, so we warn instead of fail
   if [[ "$DRY_RUN" == "true" ]]; then
    log "‚ö†Ô∏è  [DRY RUN] Missing dependency '$cmd' (ignoring for test)"
   else
    error_exit "Required command '$cmd' is not installed."
   fi
  fi
 done
}

function install_font() {

 local src_path="$SCRIPT_DIR/fonts"
 local dest_path="$HOME/.local/share/fonts"

 if [[ -f "$1" ]]; then
  src_path="$1"
 fi

 echo
 log "üíæ  Installing Fonts..."

 # Ensure destination directory exits
 log "‚öôÔ∏è  [DRY RUN] Creating directory $dest_path"
 mkdir -p "$dest_path"

 # In dry run, we skip the interactive prompts to automate the test flow
 if [[ "$DRY_RUN" == "true" ]]; then
  for font in "$src_path"/*; do
   log "üìÅ  [DRY RUN] Copying font $font to $dest_path"
  done
  log "‚öôÔ∏è  [DRY RUN] Executting command fc-cache -f"
  return 0
 fi

 safe_execute "cp -a \"$src_path/.\" \"$dest_path\""
 
 log "Rebuilding font cache..."
 safe_execute "fc-cache -f"
}

function tmux_fix() {

 log "‚ü≥   Initializing Tmux..."
 echo

 local TPM_DIR="$TMUX_CONFIG_DIR/plugins/tpm"
 local PLUGINS_DIR="$TMUX_CONFIG_DIR/plugins"

 log "üóÑÔ∏è  Saving plugin path to $TMUX_CONFIG_DIR/.tmux_meta"
 echo "$PLUGINS_DIR" >"$TMUX_CONFIG_DIR/.tmux_meta"

 if pgrep -x "tmux" >/dev/null; then
  if [[ "$DRY_RUN" == "true" ]]; then
   log "‚öôÔ∏è  [DRY RUN] Kill Tmux server."
  else
   log "‚ö†Ô∏è  A Tmux server is currently running."
   read -r -p "Kill existing Tmux server to apply changes? (y/n): " kill_ans
   if [[ "$kill_ans" == "y" ]]; then
    safe_execute "tmux kill-server 2>/dev/null || true"
   fi
  fi
 fi

 # Dracula caches status bar scripts in /tmp. If you change configs or move files
 # without clearing this, it will load the old (or default) state, ignoring your settings.
 log "üóëÔ∏è  Clearing Tmux/Dracula temporary caches..."
 echo
 safe_execute "rm -rf /tmp/tmux-dracula*" 2>/dev/null
 safe_execute "rm -rf /tmp/tmux-*" 2>/dev/null

 safe_execute "mkdir -p \"$TMUX_CONFIG_DIR\""

 if [[ ! -d "$TPM_DIR" ]]; then
  log "üíæ Installing TPM from remote (GitHub)..."
  safe_execute "git clone https://github.com/tmux-plugins/tpm \"$TPM_DIR\""
 else
  log "üëç  TPM already installed: $TMUX_CONFIG_DIR."
 fi

 # TPM requires plugin scripts (*.tmux) to be executable to auto-load.
 # Copied files often lose this attribute.
 if [[ -d "$PLUGINS_DIR" ]]; then
  log "üõÇ  Setting executable permissions for plugins..."
  safe_execute "chmod -R 755 \"$PLUGINS_DIR\""
 fi

 if [[ -x "$TPM_DIR/bin/install_plugins" ]]; then
  log "üíæ  Installing plugins..."
  safe_execute "\"$TPM_DIR/bin/install_plugins\" >/dev/null 2>&1"
 fi
}

function initialize() {
 echo
 echo "=========================================="
 log "‚ùØ‚ùØ‚ùØ‚ùØ  Initializing Dev Environment    ‚ùØ‚ùØ‚ùØ‚ùØ"
 echo "=========================================="
 echo
 check_dependencies

 # Skip prompt in dry run
 if [[ "$DRY_RUN" == "false" ]]; then
  read -r -p "Continue with initialization? (y/n): " answer
  if [[ "$answer" != "y" ]]; then
   log "Terminating..."
   exit 0
  fi
 fi

 # --- Bashrc Handling ---
 if [[ -L "$HOME/.bashrc" ]]; then
  log "üõàÔ∏é  .bashrc is already a symlink. Skipping."
 else
  log "‚õÉ Backing up existing ~/.bashrc to $BACKUP_PATH"
  safe_execute "tar -cf \"$BACKUP_PATH\" \"$HOME/.bashrc\" 2>/dev/null || true"

  log "üóëÔ∏è  Removing existing bashrc..."
  safe_execute "rm -f \"$HOME/.bashrc\""
  safe_execute "ln -s \"$SCRIPT_DIR/.bashrc\" \"$HOME/.bashrc\""
 fi

 if [[ -L "$HOME/.bashrc_aliases" ]]; then
  log "üõàÔ∏é  .bashrc_aliases is already a symlink. Skipping."
 else
  log "‚õÉ Backing up existing ~/.bashrc_aliases to $BACKUP_PATH"
  safe_execute "tar -cf \"$BACKUP_PATH\" \"$HOME/.bashrc_aliases\" 2>/dev/null || true"

  log "üóëÔ∏è  Removing existing bashrc_aliases..."
  safe_execute "rm -f \"$HOME/.bashrc_aliases\""
  safe_execute "ln -s \"$SCRIPT_DIR/.bashrc_aliases\" \"$HOME/.bashrc_aliases\""
 fi

 if [[ -L "$HOME/.bashrc_functions" ]]; then
  log "üõàÔ∏é  .bashrc_functions is already a symlink. Skipping."
 else
  log "‚õÉ Backing up existing ~/.bashrc_functions to $BACKUP_PATH"
  safe_execute "tar -cf \"$BACKUP_PATH\" \"$HOME/.bashrc_functions\" 2>/dev/null || true"

  log "üóëÔ∏è  Removing existing bashrc_functions..."
  safe_execute "rm -f \"$HOME/.bashrc_functions\""
  safe_execute "ln -s \"$SCRIPT_DIR/.bashrc_functions\" \"$HOME/.bashrc_functions\""
 fi

 # --- Tmux Config Handling ---
 local possible_paths=("$HOME/.config/tmux" "$HOME/.tmux" "$HOME/.tmux.conf")

 for possible in "${possible_paths[@]}"; do
  if [[ -e "$possible" ]]; then
   log "üîé  Found existing config: $possible. Backing up..."
   safe_execute "tar -rf \"$BACKUP_PATH\" \"$possible\" 2>/dev/null"
   safe_execute "rm -rf \"$possible\""
  fi
 done

 safe_execute "mkdir -p \"$TMUX_CONFIG_DIR\""

 log "üìÇ  Copying new tmux configuration..."
 if [[ -d "$SCRIPT_DIR/.config/tmux" ]]; then
  safe_execute "cp -rf \"$SCRIPT_DIR/.config/tmux/.\" \"$TMUX_CONFIG_DIR/\""
 else
  log "‚ö†Ô∏è   Warning: Source config directory '$SCRIPT_DIR/.config/tmux' not found."
 fi

 tmux_fix
 install_font "$SCRIPT_DIR/fonts/nerdfont.zip"

 # --- Sourcing files ---
 local aux_files=(".bashrc_packages" ".bashrc_aliases" ".bashrc_functions")
 for file in "${aux_files[@]}"; do
  if [[ -f "$SCRIPT_DIR/$file" ]]; then
   if [[ "$DRY_RUN" == "true" ]]; then
    log "ü™Ñ  [DRY RUN] Source: $SCRIPT_DIR/$file"
   else
    # shellcheck disable=SC1090
    source "$SCRIPT_DIR/$file"
   fi
  fi
 done

 log "üëç  Environment Initialized Successfully!"

 if [[ "$DRY_RUN" == "true" ]]; then
  log "‚öôÔ∏è  [DRY RUN] Execute: tmux -f $TMUX_CONFIG_DIR/tmux.conf"
 else
  if [[ -z "${TMUX:-}" ]]; then
   exec tmux -f "$TMUX_CONFIG_DIR/tmux.conf"
  else
   tmux source-file "$TMUX_CONFIG_DIR/tmux.conf"
  fi
 fi
}

# --- THE REQUESTED DRY-RUN FUNCTION ---
function start_dry_run() {
 echo "=========================================="
 echo "üöß       STARTING DRY-RUN MODE          üöß"
 echo "=========================================="

 # 1. Set the global flag
 DRY_RUN="true"

 # 2. Invoke the standard main logic
 # Because DRY_RUN is true, 'safe_execute' will intercept commands
 initialize
 
 echo
 echo "=========================================="
 echo "üèÅ       DRY-RUN MODE COMPLETE          üèÅ"
 echo "=========================================="
}

# --- Main Entry Point Logic ---
# Check if the first argument is --dry-run
if [[ "${1:-}" == "--dry-run" ]]; then
 start_dry_run
else
 # Standard execution
 echo -e "\e[90m(i) Starting initialization script...\e[0m"
 initialize
fi
