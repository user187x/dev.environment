#!/bin/bash

#Safety & Strict Mode
set -uo pipefail

DRY_RUN="false"
AUTO_ACCEPT="false"

#Global Variables
DEV_HOME="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

function log() {
 echo -e "$@"
}

function error_exit() {
 log "‚ùå Critical Error: $1"
 exit 1
}

function safe_execute() {

 local cmd="$*"

 if [[ "$DRY_RUN" == "true" ]]; then
  log "‚öôÔ∏è  [DRY RUN] Execute: $cmd"
  return 0 # Always return success in dry run so the script continues
 else
  # specific check for 'exec' which replaces the shell
  if [[ "$cmd" == exec* ]]; then
   eval "$cmd"
  else
   eval "$cmd"
  fi
 fi
}

function dependency-check() {

 local deps=("tmux" "tar" "git" "fc-cache" "vim")

 for cmd in "${deps[@]}"; do
  if ! command -v "$cmd" &>/dev/null; then
    log "‚ö†Ô∏è  Missing dependency '$cmd'"
   if [[ "$DRY_RUN" == "true" ]]; then
    log "‚ö†Ô∏è  [DRY RUN] Missing dependency '$cmd' (ignoring for test)"
   else
    echo -e "\e[90m(i) Installing required dependency $cmd\e[0m"
    sudo apt install "$cmd" -y
   fi
  fi
 done
}

function vim-enhancements {

 local src_vim_dir="$DEV_HOME/vim"
 local usr_vim_dir="$HOME/.vim"

 # Backup and rm/unlink any existsing .vimrc
 safe_execute "cp \"$HOME/.vimrc\" \"$HOME/.vimrc-bak\""

 safe_execute "unlink \"$HOME/.vimrc\" > /dev/null 2>&1"
 safe_exeucte "rm -rf \"$HOME/.vimrc\" > /dev/null 2>&1"

 log "üîó  Linking VIM resources ---"
 safe_execute "ln -s \"$src_vim_dir\" \"$usr_vim_dir\""
}

function install-media-resources {

 local src_rsc_dir="$DEV_HOME/os-mods/audio"
 local usr_rsc_dir="/opt/audio"

 # Make sure it exists
 safe_execute "mkdir -p \"$usr_rsc_dir\""

 log "üìÇ  Copying media resources..."

 safe_execute "sudo cp -rfT \"$src_rsc_dir\" \"$usr_rsc_dir\""
 safe_execute "sudo chown -R $USER:$USER \"$usr_rsc_dir\""
}

function install-terminal-fonts {

 local src_font_dir="$DEV_HOME/fonts"
 local usr_font_dir="$HOME/.local/share/fonts"

 echo
 log "üíæ  Installing resources..."

 # Ensure destination directory exits
 safe_execute "mkdir -p \"$usr_font_dir\""
 safe_execute "cp -a \"$src_font_dir/.\" \"$usr_font_dir\""
 safe_execute "fc-cache -f"
}

function install-tmux {

 log "‚ü≥   Initializing Tmux..."

 local src_tmux_dir="$DEV_HOME/tmux"
 
 local usr_tmux_dir="$HOME/.config/tmux"
 local usr_tmux_tpm_dir="$usr_tmux_dir/plugins/tpm"
 local usr_tmux_plugins_dir="$usr_tmux_dir/plugins"
 local usr_tmux_installer_dir="$usr_tmux_tpm_dir/bin/install_plugins"
 
 # --- different versions different paths
 local alt_paths=("$HOME/.config/tmux" "$HOME/.tmux" "$HOME/.tmux.conf")

 # --- Cleaning up any alternative paths that may exist
 for alt_path in "${alt_paths[@]}"; do
  if [[ -e "$alt_path" ]]; then
   safe_execute "unlink \"$alt_path\" > /dev/null 2>&1"
   safe_execute "rm -rf \"$alt_path\""
  fi
 done

 # --- ensure the directory exists
 safe_execute "mkdir -p \"$usr_tmux_dir\""
 
 log "üìÇ  Copying new tmux configuration..."
 safe_execute "ln -s \"$src_tmux_dir\" \"$usr_tmux_dir/\""

 log "üóÑÔ∏è  Creating $usr_tmux_dir/tmux.meta"
 echo "$usr_tmux_dir" > "$usr_tmux_dir/tmux.meta"

 log "üóëÔ∏è  Clearing temporary caches..."
 safe_execute "rm -rf /tmp/tmux" 2>/dev/null

 log "üíæ  Copying Tmux Plugin Manager (TPM)..."
 safe_execute "cp -raf \"$src_tmux_dir/.\" \"$usr_tmux_dir/\""

 # TPM requires plugin scripts to be executable to auto-load.
 safe_execute "chmod -R 755 \"$usr_tmux_plugins_dir\""

 # Create sub-shell to execute from temp directory
 (
  cd "/tmp"

  log "üíæ  Installing Tmux plugins..."
  safe_execute "\"$usr_tmux_installer_dir\" >/dev/null 2>&1"
 )
}

function initialize() {

 # Make sure Tmux isn't running
 if [[ -v TMUX ]]; then
  echo -e "(!) \e[1;93mQuit Tmux before proceeding\e[0m"
  exit 1
 fi

 if [[ "$DRY_RUN" == "false" ]] && [[ "$AUTO_ACCEPT" == "false" ]]; then
  echo -e "\e[90m(i) Initializing Dev-Environment\e[0m"
  read -r -p "(?) Continue (y/n): " answer
  if [[ "$answer" != "y" ]]; then
   log "Terminating..."
   exit 0
  fi
 fi

 dependency-check

 local src_dot_dir="$DEV_HOME/bash"
 local usr_dot_dir="$HOME/"

 # --- Sourcing files ---
 local dot_files=("bashrc" "bash_packages" "bash_aliases" "bash_functions" "bash_completions")

 for dot_file in "${dot_files[@]}"; do
   
  log "‚õÉ Backing up existing $usr_dot_dir/$dot_file"
  safe_execute "cp \"$usr_dot_dir/.$dot_file\" \"$usr_dot_dir/.$dot_file-bak\" 2>/dev/null || true"

  log "üõàÔ∏é  Unlinking any existing $dot_file"
  safe_execute "unlink \"$usr_dot_dir/.$dot_file\""
 
  log "üóëÔ∏è  Removing any existing $dot_file"
  safe_execute "rm -f \"$usr_dot_dir/.$dot_file\" > /dev/null 2>&1"

  log "üõàÔ∏é  Linking $src_dot_dir/$dot_file"
  safe_execute "ln -s \"$src_dot_dir/$dot_file\" \"$usr_dot_dir/$dot_file\""
 done
 
 # install terminal fonts
 install-terminal-fonts

 # install terminal sdfx
 install-media-resources

 # install tmux tpm & plugins
 install-tmux

 # install vim enhancements
 vim-enhancements
 
 for dot_file in "${dot_files[@]}"; do
  # We'll skip so we dont lose our session
  if [[ "$dot_file" != "bashrc" ]]; then
   safe_execute "source \"$usr_dot_dir/$dot_file\""
  fi
 done

 log "üëç  Environment Initialized Successfully!"

 local src_tmux_dir="$DEV_HOME/tmux"
 local usr_tmux_dir="$HOME/.config/tmux"

 if [[ -z "${TMUX:-}" ]]; then
  safe_execute "tmux -f \"$usr_tmux_dir/tmux.conf\""
 else
  safe_execute "tmux source-file \"$usr_tmux_dir/tmux.conf\""
 fi
}

function dry-run {

 echo
 echo "=========================================="
 echo "üöß       STARTING DRY-RUN MODE          üöß"
 echo "=========================================="
 echo

 initialize

 echo
 echo "=========================================="
 echo "üèÅ       DRY-RUN MODE COMPLETE          üèÅ"
 echo "=========================================="
 echo
}

# Check arguments
for arg in "$@"; do
 if [[ "$arg" == "--dry-run" || "$arg" == "-d" ]]; then
  DRY_RUN="true"
 elif [[ "$arg" == "--auto-accept" || "$arg" == "-a" ]]; then
  AUTO_ACCEPT="true"
 fi
done

# Run the main methods
if [[ "$DRY_RUN" == "true" ]];then
 dry-run
else
 initialize
fi
