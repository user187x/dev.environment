#!/bin/bash

#Safety & Strict Mode
set -uo pipefail

DRY_RUN="false"
AUTO_ACCEPT="false"

#Global Variables
DEV_HOME="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

function log() {
 echo -e "$@"
}

function error_exit() {
 log "âŒ Critical Error: $1"
 exit 1
}

function safe_execute() {

 local cmd="$*"

 if [[ "$DRY_RUN" == "true" ]]; then
  log "âš™ï¸  [DRY RUN] Execute: $cmd"
  return 0 # Always return success in dry run so the script continues
 else
  # specific check for 'exec' which replaces the shell
  if [[ "$cmd" == exec* ]]; then
   eval "$cmd"
  else
   eval "$cmd"
  fi
 fi
}

function dependency-check() {

 local deps=("tmux" "tar" "git" "fc-cache" "vim")
 for cmd in "${deps[@]}"; do
  if ! command -v "$cmd" &>/dev/null; then
   if [[ "$DRY_RUN" == "true" ]]; then
    log "âš ï¸  [DRY RUN] Missing dependency '$cmd' (ignoring for test)"
   else
    error_exit "Required command '$cmd' is not installed."
   fi
  fi
 done
}

function insert-bashrc {

 local sourcables=(".bash_packages" ".bash_aliases" ".bash_functions" ".bash_completions")
 local usr_bashrc="$HOME/.bashrc"

 # Check if its already there
 for sourcable in "${sourcables[@]}"; do
  if ! grep -q "source $sourceable" "$usr_bashrc"; then
   echo "source $HOME/$sourcable" >> "$usr_bashrc" 
  fi
 done
}

function vim-enhancements {

 local vim_src_dir="vim/resources"

 if [[ -f "$HOME/.vimrc" ]]; then
  safe_execute "mv \"$HOME/.vimrc\" \"$HOME/.vimrc-bak\""
  safe_exeucte "rm -rf \"$HOME/.vimrc\" > /dev/null 2>&1"
 fi
 if [[ -d "$HOME/.vim" ]]; then
  safe_execute "mv \"$HOME/.vim\" \"$HOME/.vim-bak\""
  safe_execute "rm -rf \"$HOME/.vim\" > /dev/null 2>&1"
 fi

 echo "linking vim config ---"
 safe_execute "ln -s \"$vim_src_dir/.vim\" \"$HOME/.vim\""
 safe_execute "ln -s \"$vim_src_dir/.vimrc\" \"$HOME/.vimrc\""
}

function install-media-resources {

 local src_rsc_dir="$DEV_HOME/os-mods/audio"
 local usr_rsc_dir="/opt/audio"

 # Make sure it exists
 safe_execute "mkdir -p \"$usr_rsc_dir\""

 log "ğŸ“‚  Copying media resources..."

 safe_execute "sudo cp -rfT \"$src_rsc_dir\" \"$usr_rsc_dir\""
 safe_execute "sudo chown -R $USER:$USER \"$usr_rsc_dir\""
}

function install-terminal-fonts {

 local src_font_dir="$DEV_HOME/fonts"
 local usr_font_dir="$HOME/.local/share/fonts"

 echo
 log "ğŸ’¾  Installing resources..."

 # Ensure destination directory exits
 safe_execute "mkdir -p \"$usr_font_dir\""

 safe_execute "cp -a \"$src_font_dir/.\" \"$usr_font_dir\""
 for font in "$src_font_dir"/*; do
  log "ğŸ“  [DRY RUN] Execute: cp -a $font to $usr_font_dir"
 done

 safe_execute "fc-cache -f"
}

function install-tmux {

 log "âŸ³   Initializing Tmux..."

 local src_tmux_dir="$DEV_HOME/.config/tmux"
 local usr_tmux_dir="$HOME/.config/tmux"
 local usr_tmux_tpm_dir="$usr_tmux_dir/plugins/tpm"
 local usr_tmux_plugins_dir="$usr_tmux_dir/plugins"
 local usr_tmux_installer_dir="$usr_tmux_tpm_dir/bin/install_plugins"
 
 # --- different versions different paths
 local alt_paths=("$HOME/.config/tmux" "$HOME/.tmux" "$HOME/.tmux.conf")

 # --- Cleaning up any alternative paths that may exist
 for alt_path in "${alt_paths[@]}"; do
  if [[ -e "$alt_path" ]]; then
   safe_execute "rm -rf \"$alt_path\""
  fi
 done

 # --- ensure the directory exists
 safe_execute "mkdir -p \"$usr_tmux_dir\""
 
 log "ğŸ“‚  Copying new tmux configuration..."
 safe_execute "cp -raf \"$src_tmux_dir\" \"$usr_tmux_dir/\""

 log "ğŸ—„ï¸  Creating $usr_tmux_dir/.tmux_meta"
 echo "$usr_tmux_dir" >"$usr_tmux_dir/.tmux_meta"

 log "ğŸ—‘ï¸  Clearing temporary caches..."
 safe_execute "rm -rf /tmp/tmux" 2>/dev/null

 log "ğŸ’¾  Copying Tmux Plugin Manager (TPM)..."
 safe_execute "cp -raf \"$src_tmux_dir/.\" \"$usr_tmux_dir/\""

 # TPM requires plugin scripts to be executable to auto-load.
 safe_execute "chmod -R 755 \"$usr_tmux_plugins_dir\""

 log "ğŸ’¾  Installing Tmux plugins..."
 safe_execute "\"$usr_tmux_installer_dir\" >/dev/null 2>&1"
}

function pre-flight-check {

 # Ensure that Tmux isn't running
 if [[ -v TMUX ]]; then
  echo -e "(!) \e[1;93mQuit Tmux before proceeding\e[0m"
  echo -e "    \e[90mCommand:\e[0m \e[38;2;232mpkill -f tmux\e[0m"
  echo
  exit 1
 fi
}

function initialize() {

 pre-flight-check

 dependency-check

 # Skip prompt in dry run
 if [[ "$DRY_RUN" == "false" ]] && [[ "$AUTO_ACCEPT" == "false" ]]; then
  echo -e "\e[90m(i) Initializing Dev-Environment\e[0m"
  read -r -p "(?) Continue (y/n): " answer
  if [[ "$answer" != "y" ]]; then
   log "Terminating..."
   exit 0
  fi
 fi

 # --- Sourcing files ---
 local bash_files=(".bashrc" ".bash_packages" ".bash_aliases" ".bash_functions" ".bash_completions")
 
 for file in "${bash_files[@]}"; do

  if [[ -L "$HOME/$file" ]]; then
   log "ğŸ›ˆï¸  $file is already a symlink. Unlinking"
   safe_execute "unlink \"$HOME/$file\""
  else
   log "â›ƒ Backing up existing $HOME/$file"
   safe_execute "cp \"$HOME/$file\" \"$HOME/$file-bak\" 2>/dev/null || true"
 
   log "ğŸ—‘ï¸  Removing existing $file"
   safe_execute "rm -f \"$HOME/$file\""
  fi

  log "ğŸ›ˆï¸  Re-symlinking .bashrc to $DEV_HOME/$file"
  safe_execute "ln -s \"$DEV_HOME/$file\" \"$HOME/$file\""
 done
 
 # install terminal fonts
 install-terminal-fonts

 # install terminal sdfx
 install-media-resources

 # install tmux tpm & plugins
 install-tmux

 # install vim enhancements
 vim-enhancements

 local sourcables=(".bash_packages" ".bash_aliases" ".bash_functions" ".bash_completions")

 for sourcable in "${sourcables[@]}"; do
  safe_execute "source \"$DEV_HOME/$sourcable\""
 done

 log "ğŸ‘  Environment Initialized Successfully!"

 local usr_tmux_dir="$HOME/.config/tmux"

 insert-bashrc

 if [[ -z "${TMUX:-}" ]]; then
  safe_execute "tmux -f \"$usr_tmux_dir/tmux.conf\""
 else
  safe_execute "tmux source-file \"$usr_tmux_dir/tmux.conf\""
 fi
}

function dry-run {

 echo
 echo "=========================================="
 echo "ğŸš§       STARTING DRY-RUN MODE          ğŸš§"
 echo "=========================================="
 echo

 initialize

 echo
 echo "=========================================="
 echo "ğŸ       DRY-RUN MODE COMPLETE          ğŸ"
 echo "=========================================="
 echo
}

# Check arguments
for arg in "$@"; do
 if [[ "$arg" == "--dry-run" ]]; then
  DRY_RUN="true"
 elif [[ "$arg" == "--auto-accept" ]]; then
  AUTO_ACCEPT="true"
 fi
done

# Run the main methods
if [[ "$DRY_RUN" == "true" ]];then
 dry-run
else
 initialize
fi
